import React, { useState, useEffect, useRef } from 'react';
import { Send, Phone, Users, Search, ArrowLeft, MoreVertical, Check, CheckCheck, Paperclip, Image, Video, Mic, File } from 'lucide-react';

export default function ChatApp() {
  const [screen, setScreen] = useState('login');
  const [phoneNumber, setPhoneNumber] = useState('');
  const [currentUser, setCurrentUser] = useState(null);
  const [contacts, setContacts] = useState([]);
  const [chats, setChats] = useState([]);
  const [selectedChat, setSelectedChat] = useState(null);
  const [messageInput, setMessageInput] = useState('');
  const [searchQuery, setSearchQuery] = useState('');
  const [showAttachMenu, setShowAttachMenu] = useState(false);
  const [isRecording, setIsRecording] = useState(false);
  const messagesEndRef = useRef(null);
  const fileInputRef = useRef(null);

  // Initialize demo data
  useEffect(() => {
    const demoContacts = [
      { id: '1', name: 'Alice Johnson', phone: '+1234567890', avatar: 'ðŸ‘©', online: true },
      { id: '2', name: 'Bob Smith', phone: '+1234567891', avatar: 'ðŸ‘¨', online: false },
      { id: '3', name: 'Carol White', phone: '+1234567892', avatar: 'ðŸ‘©â€ðŸ¦°', online: true },
      { id: '4', name: 'David Brown', phone: '+1234567893', avatar: 'ðŸ‘¨â€ðŸ¦±', online: false },
    ];
    setContacts(demoContacts);

    const demoChats = [
      {
        id: '1',
        contactId: '1',
        messages: [
          { id: 'm1', text: 'Hey! How are you?', sent: false, timestamp: new Date(Date.now() - 3600000), read: true },
          { id: 'm2', text: 'I\'m good! Thanks for asking', sent: true, timestamp: new Date(Date.now() - 3000000), read: true },
          { id: 'm3', text: 'Want to catch up later?', sent: false, timestamp: new Date(Date.now() - 1800000), read: true },
        ]
      },
      {
        id: '2',
        contactId: '2',
        messages: [
          { id: 'm4', text: 'Did you see the game last night?', sent: false, timestamp: new Date(Date.now() - 7200000), read: true },
          { id: 'm5', text: 'Yes! It was amazing!', sent: true, timestamp: new Date(Date.now() - 7000000), read: true },
        ]
      },
    ];
    setChats(demoChats);
  }, []);

  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [selectedChat, chats]);

  const handleLogin = () => {
    if (phoneNumber.trim()) {
      setCurrentUser({ phone: phoneNumber, name: 'You' });
      setScreen('chats');
    }
  };

  const handleSendMessage = () => {
    if (!messageInput.trim() || !selectedChat) return;

    const newMessage = {
      id: `m${Date.now()}`,
      text: messageInput.trim(),
      type: 'text',
      sent: true,
      timestamp: new Date(),
      read: false
    };

    setChats(prev => prev.map(chat => {
      if (chat.id === selectedChat.id) {
        return { ...chat, messages: [...chat.messages, newMessage] };
      }
      return chat;
    }));

    setMessageInput('');

    // Simulate response after 2 seconds
    setTimeout(() => {
      const responseMessage = {
        id: `m${Date.now()}`,
        text: 'Thanks for your message! ðŸ‘',
        type: 'text',
        sent: false,
        timestamp: new Date(),
        read: false
      };

      setChats(prev => prev.map(chat => {
        if (chat.id === selectedChat.id) {
          return { ...chat, messages: [...chat.messages, responseMessage] };
        }
        return chat;
      }));
    }, 2000);
  };

  const handleFileSelect = (type) => {
    const fileTypes = {
      image: 'image/*',
      video: 'video/*',
      audio: 'audio/*',
      file: '*'
    };

    if (fileInputRef.current) {
      fileInputRef.current.accept = fileTypes[type];
      fileInputRef.current.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          sendMediaMessage(file, type);
        }
      };
      fileInputRef.current.click();
    }
    setShowAttachMenu(false);
  };

  const sendMediaMessage = (file, type) => {
    const newMessage = {
      id: `m${Date.now()}`,
      text: file.name,
      type: type,
      sent: true,
      timestamp: new Date(),
      read: false,
      fileSize: (file.size / 1024).toFixed(2) + ' KB'
    };

    setChats(prev => prev.map(chat => {
      if (chat.id === selectedChat.id) {
        return { ...chat, messages: [...chat.messages, newMessage] };
      }
      return chat;
    }));
  };

  const handleVoiceRecord = () => {
    if (!isRecording) {
      setIsRecording(true);
      setTimeout(() => {
        setIsRecording(false);
        const voiceMessage = {
          id: `m${Date.now()}`,
          text: 'Voice message',
          type: 'voice',
          sent: true,
          timestamp: new Date(),
          read: false,
          duration: '0:05'
        };
        
        setChats(prev => prev.map(chat => {
          if (chat.id === selectedChat.id) {
            return { ...chat, messages: [...chat.messages, voiceMessage] };
          }
          return chat;
        }));
      }, 2000);
    }
  };

  const openChat = (contactId) => {
    let chat = chats.find(c => c.contactId === contactId);
    
    if (!chat) {
      chat = {
        id: `c${Date.now()}`,
        contactId,
        messages: []
      };
      setChats(prev => [...prev, chat]);
    }

    setSelectedChat(chat);
    setScreen('chat');
  };

  const formatTime = (date) => {
    return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
  };

  const getContact = (contactId) => {
    return contacts.find(c => c.id === contactId);
  };

  const filteredContacts = contacts.filter(contact =>
    contact.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
    contact.phone.includes(searchQuery)
  );

  // Login Screen
  if (screen === 'login') {
    return (
      <div className="h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
          <div className="text-center mb-8">
            <div className="bg-blue-500 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
              <Phone className="w-10 h-10 text-white" />
            </div>
            <h1 className="text-3xl font-bold text-gray-800 mb-2">Shivam Paliwal Chatt</h1>
            <p className="text-gray-600">Enter your mobile number to continue</p>
          </div>
          
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Mobile Number
              </label>
              <input
                type="tel"
                value={phoneNumber}
                onChange={(e) => setPhoneNumber(e.target.value)}
                placeholder="+1 234 567 8900"
                className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
              />
            </div>
            
            <button
              onClick={handleLogin}
              className="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-lg transition"
            >
              Continue
            </button>
          </div>
          
          <p className="text-xs text-gray-500 text-center mt-6">
            By continuing, you agree to our Terms of Service
          </p>
        </div>
      </div>
    );
  }

  // Contacts/Chats List Screen
  if (screen === 'chats') {
    return (
      <div className="h-screen bg-gray-100 flex flex-col">
        {/* Header */}
        <div className="bg-blue-500 text-white p-4 shadow-lg">
          <div className="flex items-center justify-between mb-4">
            <h1 className="text-2xl font-bold">Shivam Paliwal Chatt</h1>
            <MoreVertical className="w-6 h-6 cursor-pointer" />
          </div>
          
          {/* Search Bar */}
          <div className="relative">
            <Search className="absolute left-3 top-3 w-5 h-5 text-gray-400" />
            <input
              type="text"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              placeholder="Search contacts..."
              className="w-full pl-10 pr-4 py-2 rounded-lg text-gray-800 focus:outline-none"
            />
          </div>
        </div>

        {/* Contacts List */}
        <div className="flex-1 overflow-y-auto">
          {filteredContacts.map(contact => {
            const chat = chats.find(c => c.contactId === contact.id);
            const lastMessage = chat?.messages[chat.messages.length - 1];
            
            return (
              <div
                key={contact.id}
                onClick={() => openChat(contact.id)}
                className="bg-white border-b border-gray-200 p-4 hover:bg-gray-50 cursor-pointer flex items-center"
              >
                <div className="relative">
                  <div className="w-14 h-14 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-2xl">
                    {contact.avatar}
                  </div>
                  {contact.online && (
                    <div className="absolute bottom-0 right-0 w-4 h-4 bg-green-500 rounded-full border-2 border-white"></div>
                  )}
                </div>
                
                <div className="ml-4 flex-1">
                  <div className="flex justify-between items-baseline">
                    <h3 className="font-semibold text-gray-800">{contact.name}</h3>
                    {lastMessage && (
                      <span className="text-xs text-gray-500">{formatTime(lastMessage.timestamp)}</span>
                    )}
                  </div>
                  <p className="text-sm text-gray-600">{contact.phone}</p>
                  {lastMessage && (
                    <p className="text-sm text-gray-500 truncate mt-1">
                      {lastMessage.sent ? 'You: ' : ''}{lastMessage.text}
                    </p>
                  )}
                </div>
              </div>
            );
          })}
        </div>
      </div>
    );
  }

  // Chat Screen
  if (screen === 'chat' && selectedChat) {
    const contact = getContact(selectedChat.contactId);
    const messages = chats.find(c => c.id === selectedChat.id)?.messages || [];

    return (
      <div className="h-screen bg-gray-100 flex flex-col">
        {/* Chat Header */}
        <div className="bg-blue-500 text-white p-4 shadow-lg flex items-center">
          <ArrowLeft
            className="w-6 h-6 mr-4 cursor-pointer"
            onClick={() => setScreen('chats')}
          />
          <div className="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-xl">
            {contact?.avatar}
          </div>
          <div className="ml-3 flex-1">
            <h2 className="font-semibold">{contact?.name}</h2>
            <p className="text-xs text-blue-100">
              {contact?.online ? 'Online' : 'Offline'}
            </p>
          </div>
          <MoreVertical className="w-6 h-6 cursor-pointer" />
        </div>

        {/* Messages */}
        <div className="flex-1 overflow-y-auto p-4 space-y-4">
          {messages.map(message => (
            <div
              key={message.id}
              className={`flex ${message.sent ? 'justify-end' : 'justify-start'}`}
            >
              <div
                className={`max-w-xs lg:max-w-md px-4 py-2 rounded-2xl ${
                  message.sent
                    ? 'bg-blue-500 text-white rounded-br-none'
                    : 'bg-white text-gray-800 rounded-bl-none shadow'
                }`}
              >
                {/* Render different message types */}
                {message.type === 'text' && (
                  <p className="break-words">{message.text}</p>
                )}
                
                {message.type === 'image' && (
                  <div>
                    <div className="bg-gray-200 rounded-lg p-8 mb-2 flex items-center justify-center">
                      <Image className="w-12 h-12 text-gray-400" />
                    </div>
                    <p className="text-sm">{message.text}</p>
                    <p className="text-xs opacity-70">{message.fileSize}</p>
                  </div>
                )}
                
                {message.type === 'video' && (
                  <div>
                    <div className="bg-gray-200 rounded-lg p-8 mb-2 flex items-center justify-center">
                      <Video className="w-12 h-12 text-gray-400" />
                    </div>
                    <p className="text-sm">{message.text}</p>
                    <p className="text-xs opacity-70">{message.fileSize}</p>
                  </div>
                )}
                
                {message.type === 'audio' && (
                  <div className="flex items-center gap-2">
                    <div className="bg-gray-200 rounded-full p-2">
                      <Mic className="w-5 h-5 text-gray-600" />
                    </div>
                    <div>
                      <p className="text-sm">{message.text}</p>
                      <p className="text-xs opacity-70">{message.fileSize}</p>
                    </div>
                  </div>
                )}
                
                {message.type === 'voice' && (
                  <div className="flex items-center gap-3">
                    <div className={`${message.sent ? 'bg-blue-600' : 'bg-blue-500'} rounded-full p-2`}>
                      <Mic className={`w-4 h-4 ${message.sent ? 'text-white' : 'text-white'}`} />
                    </div>
                    <div className="flex-1">
                      <div className="flex items-center gap-1">
                        <div className="flex gap-0.5">
                          {[...Array(20)].map((_, i) => (
                            <div key={i} className={`w-0.5 ${message.sent ? 'bg-white' : 'bg-gray-400'}`} style={{height: `${Math.random() * 16 + 4}px`}}></div>
                          ))}
                        </div>
                      </div>
                      <p className="text-xs opacity-70 mt-1">{message.duration}</p>
                    </div>
                  </div>
                )}
                
                {message.type === 'file' && (
                  <div className="flex items-center gap-2">
                    <div className="bg-gray-200 rounded-full p-2">
                      <File className="w-5 h-5 text-gray-600" />
                    </div>
                    <div>
                      <p className="text-sm">{message.text}</p>
                      <p className="text-xs opacity-70">{message.fileSize}</p>
                    </div>
                  </div>
                )}
                
                <div className={`flex items-center justify-end gap-1 mt-1 text-xs ${
                  message.sent ? 'text-blue-100' : 'text-gray-500'
                }`}>
                  <span>{formatTime(message.timestamp)}</span>
                  {message.sent && (
                    message.read ? <CheckCheck className="w-4 h-4" /> : <Check className="w-4 h-4" />
                  )}
                </div>
              </div>
            </div>
          ))}
          <div ref={messagesEndRef} />
        </div>

        {/* Message Input */}
        <div className="bg-white border-t border-gray-200 p-4">
          <input
            ref={fileInputRef}
            type="file"
            className="hidden"
          />
          
          {/* Attachment Menu */}
          {showAttachMenu && (
            <div className="absolute bottom-20 left-4 bg-white rounded-2xl shadow-2xl p-4 mb-2">
              <div className="grid grid-cols-2 gap-3">
                <button
                  onClick={() => handleFileSelect('image')}
                  className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-gray-50 transition"
                >
                  <div className="bg-purple-500 p-3 rounded-full">
                    <Image className="w-6 h-6 text-white" />
                  </div>
                  <span className="text-sm text-gray-700">Photo</span>
                </button>
                
                <button
                  onClick={() => handleFileSelect('video')}
                  className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-gray-50 transition"
                >
                  <div className="bg-red-500 p-3 rounded-full">
                    <Video className="w-6 h-6 text-white" />
                  </div>
                  <span className="text-sm text-gray-700">Video</span>
                </button>
                
                <button
                  onClick={() => handleFileSelect('audio')}
                  className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-gray-50 transition"
                >
                  <div className="bg-orange-500 p-3 rounded-full">
                    <Mic className="w-6 h-6 text-white" />
                  </div>
                  <span className="text-sm text-gray-700">Audio</span>
                </button>
                
                <button
                  onClick={() => handleFileSelect('file')}
                  className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-gray-50 transition"
                >
                  <div className="bg-blue-500 p-3 rounded-full">
                    <File className="w-6 h-6 text-white" />
                  </div>
                  <span className="text-sm text-gray-700">File</span>
                </button>
              </div>
            </div>
          )}
          
          <div className="flex items-center gap-2">
            <button
              onClick={() => setShowAttachMenu(!showAttachMenu)}
              className="text-gray-500 hover:text-gray-700 p-2 rounded-full hover:bg-gray-100 transition"
            >
              <Paperclip className="w-6 h-6" />
            </button>
            
            <input
              type="text"
              value={messageInput}
              onChange={(e) => setMessageInput(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
              placeholder="Type a message..."
              className="flex-1 px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:border-blue-500"
            />
            
            {messageInput.trim() ? (
              <button
                onClick={handleSendMessage}
                className="bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-full transition"
              >
                <Send className="w-5 h-5" />
              </button>
            ) : (
              <button
                onClick={handleVoiceRecord}
                className={`${isRecording ? 'bg-red-500 animate-pulse' : 'bg-blue-500'} hover:bg-blue-600 text-white p-3 rounded-full transition`}
              >
                <Mic className="w-5 h-5" />
              </button>
            )}
          </div>
          
          {isRecording && (
            <div className="text-center mt-2 text-sm text-red-500 animate-pulse">
              Recording voice message...
            </div>
          )}
        </div>
      </div>
    );
  }

  return null;
}
